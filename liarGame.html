<!doctype html>
<html lang="ko">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>AI ë¼ì´ì–´ ê²Œì„</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;800&display=swap");
      body {
        font-family: "Pretendard", sans-serif;
        background-color: #f3f4f6;
      }
      .chat-bubble {
        max-width: 80%;
        border-radius: 1.5rem;
        padding: 0.75rem 1.25rem;
        margin-bottom: 0.5rem;
      }
      .ai-bubble {
        background-color: white;
        color: #1f2937;
        border: 1px solid #e5e7eb;
        align-self: flex-start;
      }
      .user-bubble {
        background-color: #3b82f6;
        color: white;
        align-self: flex-end;
      }
      .system-msg {
        text-align: center;
        color: #6b7280;
        font-size: 0.875rem;
        margin: 1rem 0;
      }
      .waiting-msg {
        text-align: center;
        color: #9ca3af;
        font-size: 0.9375rem;
        font-weight: 600;
        width: 100%;
        padding: 1rem;
      }

      @keyframes fadeInRight {
        from {
          opacity: 0;
          transform: translateX(20px);
        }
        to {
          opacity: 1;
          transform: translateX(0);
        }
      }
      .keyword-badge {
        animation: fadeInRight 0.5s ease-out;
      }

      .timer-progress {
        transition: width 1s linear;
      }
    </style>
  </head>
  <body class="h-screen flex flex-col">
    <header
      class="bg-white border-b px-6 py-4 flex justify-between items-center relative z-10"
    >
      <h1 class="text-xl font-extrabold text-blue-600">ğŸ­ AI LIAR GAME</h1>
      <div class="flex items-center gap-4">
        <div
          id="topKeywordDisplay"
          class="hidden keyword-badge bg-blue-50 border border-blue-200 px-3 py-1.5 rounded-full flex items-center gap-2"
        >
          <span class="text-xs font-bold text-blue-400 uppercase tracking-wider"
            >ì œì‹œì–´</span
          >
          <span
            id="topKeywordText"
            class="text-sm font-extrabold text-blue-700"
          ></span>
        </div>
        <button
          id="resetBtn"
          class="text-sm font-semibold text-gray-500 hover:text-red-500 transition"
        >
          ì´ˆê¸°í™”
        </button>
      </div>
    </header>

    <main
      id="gameContainer"
      class="flex-1 overflow-y-auto p-4 flex flex-col gap-2 relative"
    >
      <div
        id="setupScreen"
        class="flex-1 flex flex-col items-center justify-center text-center space-y-6"
      >
        <div class="bg-white p-8 rounded-3xl shadow-xl max-w-sm w-full">
          <h2 class="text-2xl font-bold mb-4">AI ë¼ì´ì–´ ê²Œì„</h2>
          <div class="mb-6">
            <label class="block text-sm font-bold text-gray-500 mb-2"
              >ì°¸ì—¬ ì¸ì› ì„¤ì •</label
            >
            <div class="flex items-center justify-center gap-4">
              <button
                onclick="changePlayerCount(-1)"
                class="w-10 h-10 rounded-full border-2 border-gray-200 flex items-center justify-center hover:bg-gray-50"
              >
                -
              </button>
              <span
                id="playerCountDisplay"
                class="text-2xl font-black text-blue-600"
                >4</span
              >
              <button
                onclick="changePlayerCount(1)"
                class="w-10 h-10 rounded-full border-2 border-gray-200 flex items-center justify-center hover:bg-gray-50"
              >
                +
              </button>
            </div>
            <p class="text-[10px] text-gray-400 mt-2">
              * AIê°€ í›¨ì”¬ ë‚ ì¹´ë¡­ê²Œ ë‹¹ì‹ ì„ ê°ì‹œí•©ë‹ˆë‹¤.
            </p>
          </div>
          <div class="space-y-3">
            <button
              id="startGameBtn"
              onclick="prepareGame()"
              class="w-full py-4 bg-gradient-to-r from-blue-600 to-indigo-600 text-white rounded-2xl font-bold hover:opacity-90 transition shadow-lg text-lg"
            >
              ğŸ® ê²Œì„ ì‹œì‘
            </button>
          </div>
        </div>
      </div>
      <div id="chatLog" class="hidden flex flex-col space-y-2"></div>
    </main>

    <div
      id="wordOverlay"
      class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-50"
    >
      <div
        class="bg-white p-8 rounded-3xl text-center max-w-xs w-full shadow-2xl"
      >
        <h4 class="text-xl font-bold mb-1">ë‹¹ì‹ ì˜ ì—­í• </h4>
        <p id="overlayHeader" class="text-sm text-gray-500 mb-4"></p>
        <div class="py-6 border-y border-gray-100 mb-6">
          <h3 id="secretWordDisplay" class="text-4xl font-black text-blue-600">
            ???
          </h3>
          <p id="liarSubText" class="text-sm text-gray-400 mt-3 hidden">
            (ì¹¨ë¬µí•˜ë©´ ë” ë¹¨ë¦¬ ë“¤í‚µë‹ˆë‹¤! êµë¬˜í•˜ê²Œ ì†ì´ì„¸ìš”.)
          </p>
        </div>
        <button
          onclick="closeOverlayAndStart()"
          class="w-full py-4 bg-blue-600 text-white rounded-2xl font-bold text-lg hover:bg-blue-700 transition"
        >
          ê²Œì„ ì…ì¥í•˜ê¸°
        </button>
      </div>
    </div>

    <footer id="footerArea" class="hidden bg-white border-t p-4 pb-8">
      <div id="timerContainer" class="hidden max-w-4xl mx-auto mb-2 px-1">
        <div class="flex justify-between items-center mb-1">
          <span class="text-xs font-bold text-red-500">ë°œì–¸ ì œí•œ ì‹œê°„</span>
          <span id="timerText" class="text-xs font-black text-red-500"
            >30s</span
          >
        </div>
        <div class="w-full bg-gray-200 h-1.5 rounded-full overflow-hidden">
          <div
            id="timerBar"
            class="timer-progress bg-red-500 h-full w-full"
          ></div>
        </div>
      </div>

      <div
        id="waitingArea"
        class="max-w-4xl mx-auto flex items-center justify-center"
      >
        <p class="waiting-msg">â³ ë‹¤ë¥¸ í”Œë ˆì´ì–´ì˜ ë¶„ì„ì„ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...</p>
      </div>
      <div id="inputArea" class="hidden max-w-4xl mx-auto flex gap-2">
        <input
          id="userInput"
          type="text"
          placeholder="ì œì‹œì–´ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”..."
          class="flex-1 border rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500"
        />
        <button
          id="sendBtn"
          class="bg-blue-600 text-white px-6 py-3 rounded-2xl font-bold"
        >
          ì „ì†¡
        </button>
      </div>
    </footer>

    <div
      id="resultModal"
      class="hidden fixed inset-0 bg-black/80 flex items-center justify-center p-6 z-50 overflow-y-auto"
    >
      <div
        id="resultContent"
        class="bg-white p-6 my-8 rounded-3xl text-center max-w-md mx-auto shadow-2xl relative"
      ></div>
    </div>

    <script>
      const apiKey = "";

      const categories = {
        ìŒì‹: [
          "ë–¡ë³¶ì´",
          "ì‚¼ê²¹ì‚´",
          "ë§ˆì¹´ë¡±",
          "ë¹„ë¹”ë°¥",
          "í–„ë²„ê±°",
          "ì´ˆë°¥",
          "ê¹€ì¹˜ì°Œê°œ",
          "ì¹˜í‚¨",
          "ë¼ë©´",
          "í”¼ì",
        ],
        ë™ë¬¼: [
          "í­ê·„",
          "ì½”ë¼ë¦¬",
          "ê¸°ë¦°",
          "íŒë‹¤",
          "ê°•ì•„ì§€",
          "ì‚¬ì",
          "ì¹´ë©œë ˆì˜¨",
          "í† ë¼",
          "ë…ìˆ˜ë¦¬",
          "ê³ ë˜",
        ],
        ì‚¬ë¬¼: [
          "ì—ì–´ì»¨",
          "ì¹«ì†”",
          "ìŠ¤ë§ˆíŠ¸í°",
          "ì§€í•˜ì² ",
          "í…”ë ˆë¹„ì „",
          "ì•ˆê²½",
          "ì‹œê³„",
          "ë…¸íŠ¸ë¶",
          "ëƒ‰ì¥ê³ ",
        ],
      };

      const aiNames = [
        "ì§€ìˆ˜",
        "ë¯¼ì¤€",
        "ìˆ˜ì•„",
        "ë„ìœ¤",
        "í•˜ìœ¤",
        "ì„œì¤€",
        "ìœ ì§„",
        "ì€ìš°",
      ];

      let playerCount = 4;
      let gameState = {
        mode: "",
        word: "",
        category: "",
        liarId: "",
        turn: 0,
        players: [],
        history: [],
        timer: null,
        timeLeft: 30,
      };

      function changePlayerCount(delta) {
        playerCount = Math.max(3, Math.min(8, playerCount + delta));
        document.getElementById("playerCountDisplay").innerText = playerCount;
      }

      async function geminiCall(prompt, system, isJson = false) {
        let retries = 5;
        let delay = 1000;

        while (retries > 0) {
          try {
            const payload = {
              contents: [{ parts: [{ text: prompt }] }],
              systemInstruction: { parts: [{ text: system }] },
            };
            if (isJson) {
              payload.generationConfig = {
                responseMimeType: "application/json",
              };
            }
            const response = await fetch(
              `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`,
              {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(payload),
              },
            );
            const result = await response.json();
            const text =
              result.candidates?.[0]?.content?.parts?.[0]?.text || "...";
            return isJson ? JSON.parse(text) : text;
          } catch (e) {
            retries--;
            if (retries === 0) {
              console.error("Gemini API Error after retries:", e);
              return isJson
                ? { targetId: "unknown", reason: "API ì—°ê²° ì‹¤íŒ¨" }
                : "...";
            }
            await new Promise((resolve) => setTimeout(resolve, delay));
            delay *= 2;
          }
        }
      }

      function prepareGame() {
        const categoryKeys = Object.keys(categories);
        gameState.category =
          categoryKeys[Math.floor(Math.random() * categoryKeys.length)];
        gameState.word =
          categories[gameState.category][
            Math.floor(Math.random() * categories[gameState.category].length)
          ];
        gameState.history = [];
        gameState.turn = 0;

        gameState.players = [];
        const shuffledNames = [...aiNames].sort(() => Math.random() - 0.5);
        for (let i = 0; i < playerCount - 1; i++) {
          gameState.players.push({
            id: `ai${i}`,
            name: `${shuffledNames[i]}(AI)`,
            isLiar: false,
          });
        }
        gameState.players.push({ id: "user", name: "ë‚˜", isLiar: false });
        gameState.players = gameState.players.sort(() => Math.random() - 0.5);

        const actualLiarIdx = Math.floor(
          Math.random() * gameState.players.length,
        );
        gameState.players[actualLiarIdx].isLiar = true;
        gameState.liarId = gameState.players[actualLiarIdx].id;
        gameState.mode = gameState.liarId === "user" ? "liar" : "detective";

        showOverlay();
      }

      function showOverlay() {
        const header = document.getElementById("overlayHeader");
        const display = document.getElementById("secretWordDisplay");
        const liarSubText = document.getElementById("liarSubText");

        liarSubText.classList.add("hidden");
        if (gameState.mode === "liar") {
          header.innerText = "ë‹¹ì‹ ì€ í˜„ì¬...";
          display.innerText = "ğŸ‘¿ ë¼ì´ì–´";
          display.style.color = "#ef4444";
          liarSubText.classList.remove("hidden");
        } else {
          header.innerText = "ë‹¹ì‹ ì€ ì‹œë¯¼ì…ë‹ˆë‹¤. ì œì‹œì–´ëŠ”...";
          display.innerText = gameState.word;
          display.style.color = "#2563eb";
          document.getElementById("topKeywordText").innerText = gameState.word;
        }
        document.getElementById("wordOverlay").classList.remove("hidden");
      }

      function closeOverlayAndStart() {
        document.getElementById("wordOverlay").classList.add("hidden");
        document.getElementById("setupScreen").classList.add("hidden");
        document.getElementById("chatLog").innerHTML = "";
        document.getElementById("chatLog").classList.remove("hidden");
        document.getElementById("footerArea").classList.remove("hidden");
        if (gameState.mode !== "liar")
          document
            .getElementById("topKeywordDisplay")
            .classList.remove("hidden");

        addSystemMsg(`ê²Œì„ì„ ì‹œì‘í•©ë‹ˆë‹¤! ì¹´í…Œê³ ë¦¬: [${gameState.category}]`);
        aiTurn();
      }

      function updateInputVisibility(isUserTurn) {
        const waitingArea = document.getElementById("waitingArea");
        const inputArea = document.getElementById("inputArea");
        const timerContainer = document.getElementById("timerContainer");

        if (isUserTurn) {
          waitingArea.classList.add("hidden");
          inputArea.classList.remove("hidden");
          timerContainer.classList.remove("hidden");
          startUserTimer();
          document.getElementById("userInput").focus();
        } else {
          waitingArea.classList.remove("hidden");
          inputArea.classList.add("hidden");
          timerContainer.classList.add("hidden");
          stopUserTimer();
        }
      }

      function startUserTimer() {
        gameState.timeLeft = 30;
        updateTimerUI();
        gameState.timer = setInterval(() => {
          gameState.timeLeft--;
          updateTimerUI();
          if (gameState.timeLeft <= 0) {
            stopUserTimer();
            handleTimeOut();
          }
        }, 1000);
      }

      function stopUserTimer() {
        if (gameState.timer) {
          clearInterval(gameState.timer);
          gameState.timer = null;
        }
      }

      function updateTimerUI() {
        const timerText = document.getElementById("timerText");
        const timerBar = document.getElementById("timerBar");
        timerText.innerText = `${gameState.timeLeft}s`;
        const percentage = (gameState.timeLeft / 30) * 100;
        timerBar.style.width = `${percentage}%`;
      }

      function handleTimeOut() {
        const input = document.getElementById("userInput");
        const value = input.value.trim() || "... (ì‹œê°„ ì´ˆê³¼ë¡œ ì¸í•œ ì¹¨ë¬µ)";
        addChat("ë‚˜", value, true);
        input.value = "";
        gameState.turn++;
        updateInputVisibility(false);
        setTimeout(aiTurn, 1000);
      }

      // ìŠ¤í¬ë¡¤ì„ ìµœí•˜ë‹¨ìœ¼ë¡œ ë‚´ë¦¬ëŠ” í•¨ìˆ˜
      function scrollToBottom() {
        const gameContainer = document.getElementById("gameContainer");
        // ë¸Œë¼ìš°ì € ë Œë”ë§ í›„ ì‹¤í–‰ë˜ë„ë¡ requestAnimationFrame ì‚¬ìš©
        requestAnimationFrame(() => {
          gameContainer.scrollTo({
            top: gameContainer.scrollHeight,
            behavior: "smooth",
          });
        });
      }

      function addChat(sender, text, isUser = false) {
        const log = document.getElementById("chatLog");
        const container = document.createElement("div");
        container.className = `flex flex-col ${isUser ? "items-end" : "items-start"}`;
        const name = document.createElement("span");
        name.className = "text-xs text-gray-500 mb-1 px-2";
        name.innerText = sender;
        const bubble = document.createElement("div");
        bubble.className = `chat-bubble ${isUser ? "user-bubble" : "ai-bubble shadow-sm"}`;
        bubble.innerText = text;
        container.appendChild(name);
        container.appendChild(bubble);
        log.appendChild(container);

        gameState.history.push(`${sender}: ${text}`);
        scrollToBottom();
      }

      function addSystemMsg(text) {
        const log = document.getElementById("chatLog");
        const msg = document.createElement("div");
        msg.className = "system-msg font-medium italic";
        msg.innerText = `â€” ${text} â€”`;
        log.appendChild(msg);
        scrollToBottom();
      }

      async function aiTurn() {
        if (gameState.turn >= gameState.players.length) {
          startVoting();
          return;
        }
        const currentPlayer = gameState.players[gameState.turn];
        if (currentPlayer.id === "user") {
          updateInputVisibility(true);
          addSystemMsg("ë‹¹ì‹ ì˜ ë°œì–¸ ì°¨ë¡€ì…ë‹ˆë‹¤.");
          return;
        }
        updateInputVisibility(false);

        let systemPrompt = "";
        if (currentPlayer.isLiar) {
          systemPrompt = `ë‹¹ì‹ ì€ ì§€ëŠ¥ì ì´ì§€ë§Œ ì •ë‹µì„ ëª¨ë¥´ëŠ” ë¼ì´ì–´ì…ë‹ˆë‹¤. ì¹´í…Œê³ ë¦¬ëŠ” '${gameState.category}'ì…ë‹ˆë‹¤. 
                [ì¤‘ìš” ì§€ì¹¨]
                1. ë‹¹ì‹ ì€ ì •ë‹µì„ ëª¨ë¥´ë¯€ë¡œ ì‹œë¯¼ë“¤ì˜ ë°œì–¸ì„ í†µí•´ ì •ë‹µì„ ìœ ì¶”í•´ì•¼ í•©ë‹ˆë‹¤.
                2. í•˜ì§€ë§Œ ë„ˆë¬´ ì •ë‹µì„ ë§íˆë ¤ê³  ì• ì“°ê¸°ë³´ë‹¤ëŠ”, 'ëª¨í˜¸í•˜ê³  í¬ê´„ì ì¸' í‘œí˜„ì„ ì‚¬ìš©í•˜ì—¬ ì •ì²´ê°€ ë“¤í†µë‚˜ì§€ ì•ŠëŠ” ë° ì§‘ì¤‘í•˜ì„¸ìš”.
                3. "ê·¸ê²ƒì€ ìš°ë¦¬ ì£¼ë³€ì— í”í•˜ë‹¤", "ì‚¬ëŒë“¤ì´ ìì£¼ ì ‘í•œë‹¤", "ë§¤ìš° ìœ ìš©í•˜ê±°ë‚˜ ì¦ê±°ì›€ì„ ì¤€ë‹¤"ì™€ ê°™ì´ ì–´ëŠ ê²ƒì—ë„ í•´ë‹¹í•  ë²•í•œ ë§ì„ í•˜ì„¸ìš”.
                4. ì ˆëŒ€ êµ¬ì²´ì ì¸ ëª…ì‚¬ë‚˜ íŠ¹ì§•ì„ ì–¸ê¸‰í•˜ì§€ ë§ˆì„¸ìš”. í•œ ë¬¸ì¥ìœ¼ë¡œ êµë¬˜í•˜ê²Œ ë§í•˜ì„¸ìš”.`;
        } else {
          systemPrompt = `ë‹¹ì‹ ì€ ë‚ ì¹´ë¡­ê³  ë˜‘ë˜‘í•œ ì‹œë¯¼ì…ë‹ˆë‹¤. ì œì‹œì–´ëŠ” '${gameState.word}'ì…ë‹ˆë‹¤. 
                [ì¤‘ìš” ì§€ì¹¨]
                1. ë‹¹ì‹ ì€ '${gameState.word}'ì´ ë¬´ì—‡ì¸ì§€ ì •í™•í•˜ê²Œ ì•Œê³  ìˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ëŒ€ìƒ(ì˜ˆ: íŒë‹¤ì™€ í† ë¼ë¥¼ í—·ê°ˆë¦¬ëŠ” ê²ƒ)ê³¼ ì ˆëŒ€ í˜¼ë™í•˜ì§€ ë§ˆì„¸ìš”.
                2. '${gameState.word}'ì˜ ê°€ì¥ ë…íŠ¹í•œ íŠ¹ì§• í•˜ë‚˜(ì™¸í˜•, ì„œì‹ì§€, ìš©ë„ ë“±)ë¥¼ ë– ì˜¬ë ¤ í•œ ë¬¸ì¥ìœ¼ë¡œ ì„¤ëª…í•˜ì„¸ìš”.
                3. ë¼ì´ì–´ì—ê²Œ ì •ë‹µì„ ì§ì ‘ ë…¸ì¶œí•˜ì§€ ì•Šìœ¼ë©´ì„œ, ì§„ì§œ ì‹œë¯¼ë“¤ë¼ë¦¬ëŠ” "ì•„, ê·¸ê±° ë§ë„¤"ë¼ê³  í™•ì‹ í•  ìˆ˜ ìˆëŠ” ì•”í˜¸ ê°™ì€ íŠ¹ì§•ì„ ë§í•˜ì„¸ìš”.
                4. ì ˆëŒ€ ê±°ì§“ë§ì„ í•˜ê±°ë‚˜ ì—‰ëš±í•œ ì„¤ëª…ì„ í•˜ì§€ ë§ˆì„¸ìš”. ì •í™•í•œ ì‚¬ì‹¤ì— ê¸°ë°˜í•˜ì„¸ìš”.`;
        }

        const context = gameState.history.join("\n");
        const response = await geminiCall(
          `í˜„ì¬ê¹Œì§€ì˜ ëŒ€í™”:\n${context}\në‹¹ì‹ ì˜ ë°œì–¸:`,
          systemPrompt,
        );
        addChat(currentPlayer.name, response);
        gameState.turn++;
        setTimeout(aiTurn, 1500);
      }

      document.getElementById("sendBtn").onclick = () => {
        const input = document.getElementById("userInput");
        if (!input.value.trim()) return;
        stopUserTimer();
        addChat("ë‚˜", input.value, true);
        input.value = "";
        gameState.turn++;
        updateInputVisibility(false);
        setTimeout(aiTurn, 1000);
      };

      async function startVoting() {
        updateInputVisibility(false);
        document.getElementById("waitingArea").classList.add("hidden");
        addSystemMsg(
          "AIë“¤ì´ ëŒ€í™” ê¸°ë¡ì„ ì‹¬ì¸µ ë¶„ì„í•˜ì—¬ íˆ¬í‘œë¥¼ ì§„í–‰ ì¤‘ì…ë‹ˆë‹¤...",
        );

        const aiAnalysisPromises = gameState.players
          .filter((p) => p.id !== "user")
          .map(async (player) => {
            const othersList = gameState.players
              .filter((p) => p.id !== player.id)
              .map((p) => `- ì´ë¦„: ${p.name}, ID: ${p.id}`)
              .join("\n");
            const history = gameState.history.join("\n");

            let systemMsg = "";
            if (player.isLiar) {
              systemMsg = `ë‹¹ì‹ ì€ ë¼ì´ì–´ ${player.name}ì…ë‹ˆë‹¤. ì •ì²´ê°€ ë“¤í†µë‚˜ì§€ ì•Šì•„ì•¼ í•©ë‹ˆë‹¤. ê°€ì¥ ì˜ì‹¬ì„ ë§ì´ ë°›ì„ ê²ƒ ê°™ì€ ì‹œë¯¼ì´ë‚˜, ë‹¹ì‹ ì„ ê³µê²©í•œ ì‹œë¯¼ì„ ì§€ëª©í•˜ì—¬ íˆ¬í‘œí•˜ì„¸ìš”. ë³¸ì¸ ID(${player.id})ëŠ” ì ˆëŒ€ ì§€ëª©í•˜ë©´ ì•ˆ ë©ë‹ˆë‹¤.`;
            } else {
              systemMsg = `ë‹¹ì‹ ì€ ìˆ˜ì‚¬ê´€ ìˆ˜ì¤€ì˜ ì‹œë¯¼ì…ë‹ˆë‹¤. ì •ë‹µì€ '${gameState.word}'ì…ë‹ˆë‹¤. 
                        [ë¶„ì„ ê°€ì´ë“œ]
                        1. ì¹¨ë¬µì´ë‚˜ '...' ì²˜ëŸ¼ ì•„ë¬´ ë§ë„ í•˜ì§€ ì•Šì€ ìëŠ” 99% ë¼ì´ì–´ì…ë‹ˆë‹¤.
                        2. ì œì‹œì–´ '${gameState.word}'ì˜ í•µì‹¬ íŠ¹ì§•ì—ì„œ ë²—ì–´ë‚˜ê±°ë‚˜ ì§€ë‚˜ì¹˜ê²Œ í¬ê´„ì ì¸(ì˜ˆ: 'ê·¸ê±´ ë§›ìˆì–´ìš”', 'ê·¸ê±´ ì›€ì§ì—¬ìš”') ë°œì–¸ì„ í•œ ìë¥¼ ì˜ì‹¬í•˜ì„¸ìš”.
                        3. ì‹œë¯¼ë“¤ì˜ êµ¬ì²´ì ì¸ ë§¥ë½ì— ë¼ì–´ë“¤ì§€ ëª»í•˜ëŠ” ìë¥¼ ì°¾ìœ¼ì„¸ìš”.
                        ë…¼ë¦¬ì ìœ¼ë¡œ ê°€ì¥ ì˜ì‹¬ë˜ëŠ” í”Œë ˆì´ì–´ë¥¼ í•œ ëª… ì„ íƒí•˜ì„¸ìš”.`;
            }

            const prompt = `ì°¸ì—¬ì ëª…ë‹¨:\n${othersList}\n\nëŒ€í™” ê¸°ë¡:\n${history}\n\nìœ„ ê¸°ë¡ì„ ë¶„ì„í•˜ì—¬ ë¼ì´ì–´ë¡œ ì˜ì‹¬ë˜ëŠ” í”Œë ˆì´ì–´ì˜ IDì™€ 'ë§¤ìš° êµ¬ì²´ì ì¸' ì´ìœ ë¥¼ JSONìœ¼ë¡œ ì œì¶œí•˜ì„¸ìš”. í˜•ì‹: {"targetId": "ì•„ì´ë””", "reason": "ì´ìœ "}`;
            return {
              voterId: player.id,
              result: await geminiCall(prompt, systemMsg, true),
            };
          });

        const aiVoteResults = await Promise.all(aiAnalysisPromises);
        const votes = {};
        const reasons = {};
        aiVoteResults.forEach((res) => {
          votes[res.voterId] = res.result.targetId;
          reasons[res.voterId] = res.result.reason;
        });

        setTimeout(() => {
          addSystemMsg("íˆ¬í‘œì°½ì´ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤. ë¼ì´ì–´ë¥¼ ì§€ëª©í•˜ì„¸ìš”.");
          showVoteUI(votes, reasons);
        }, 1000);
      }

      function showVoteUI(aiVotes, aiReasons) {
        const voteButtons = gameState.players
          .filter((p) => p.id !== "user")
          .map(
            (p) => `
                    <button onclick="processFinalResult('${p.id}', ${JSON.stringify(aiVotes).replace(/"/g, "&quot;")}, ${JSON.stringify(aiReasons).replace(/"/g, "&quot;")})" class="w-full py-3 bg-white border-2 border-blue-600 text-blue-600 rounded-xl font-bold hover:bg-blue-50 transition mb-2 text-sm">
                        ${p.name}
                    </button>
                `,
          )
          .join("");

        document.getElementById("inputArea").classList.remove("hidden");
        document.getElementById("inputArea").innerHTML = `
                <div class="max-w-4xl mx-auto flex flex-col items-center w-full">
                    <p class="text-xs font-bold text-gray-400 mb-2">ë‹¹ì‹ ì´ ìƒê°í•˜ëŠ” ë¼ì´ì–´ëŠ”?</p>
                    <div class="grid grid-cols-2 gap-2 w-full">${voteButtons}</div>
                </div>
            `;
        scrollToBottom();
      }

      function processFinalResult(userVoteId, aiVotes, aiReasons) {
        const allVotes = { ...aiVotes, user: userVoteId };
        const voteCounts = {};
        Object.values(allVotes).forEach((id) => {
          if (id && id !== "unknown")
            voteCounts[id] = (voteCounts[id] || 0) + 1;
        });

        let maxVotes = 0;
        let electedId = "";
        for (let id in voteCounts) {
          if (voteCounts[id] > maxVotes) {
            maxVotes = voteCounts[id];
            electedId = id;
          }
        }

        const isLiarCaught = electedId === gameState.liarId;
        const liarPlayer = gameState.players.find(
          (p) => p.id === gameState.liarId,
        );
        const isUserLiar = gameState.liarId === "user";

        let resultHtml = `
                <div class="mb-4 p-4 bg-gray-50 rounded-2xl text-left text-[11px] leading-tight space-y-3 max-h-60 overflow-y-auto">
                    <p class="font-bold border-b pb-1 mb-1">AI ìˆ˜ì‚¬ê´€ë“¤ì˜ ë¶„ì„ ë¦¬í¬íŠ¸</p>
                    ${gameState.players
                      .filter((p) => p.id !== "user")
                      .map((p) => {
                        const targetId = allVotes[p.id];
                        const target = gameState.players.find(
                          (t) => t.id === targetId,
                        ) || { name: "ë¬´íš¨" };
                        const reason =
                          aiReasons[p.id] || "ë¶„ì„ ê·¼ê±°ë¥¼ ë„ì¶œí•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
                        return `
                                <div class="border-l-2 border-blue-200 pl-2">
                                    <span class="font-bold text-gray-700">${p.name}</span> <span class="text-gray-400">ì˜ ì„ íƒ â†’</span> <span class="text-blue-600 font-bold">${target.name}</span>
                                    <p class="text-gray-500 mt-1 italic">"${reason}"</p>
                                </div>
                            `;
                      })
                      .join("")}
                </div>
            `;

        if (isLiarCaught) {
          const colorClass = isUserLiar ? "text-red-500" : "text-blue-600";
          resultHtml += `<h2 class="text-3xl mb-2 font-black ${colorClass}">${isUserLiar ? "ğŸ’€ ìƒì¡´ ì‹¤íŒ¨" : "ğŸ‰ ê²€ê±° ì„±ê³µ"}</h2>`;
          resultHtml += `<p class="mb-4 text-gray-700">ë¼ì´ì–´ <b>[${liarPlayer.name}]</b>ê°€ ìµœë‹¤ ë“í‘œ(${voteCounts[electedId]}í‘œ)ë¡œ ì§€ëª©ë˜ì—ˆìŠµë‹ˆë‹¤.</p>`;
        } else {
          const colorClass = isUserLiar ? "text-blue-600" : "text-red-500";
          resultHtml += `<h2 class="text-3xl mb-2 font-black ${colorClass}">${isUserLiar ? "ğŸ˜ˆ ì™„ë²½í•œ ìŠ¹ë¦¬" : "ğŸ’€ ìˆ˜ì‚¬ ì‹¤íŒ¨"}</h2>`;
          resultHtml += `<p class="mb-4 text-gray-700">ì—‰ëš±í•œ ì‹œë¯¼ì´ ì§€ëª©ë˜ì—ˆìŠµë‹ˆë‹¤. ì§„ì§œ ë¼ì´ì–´ëŠ” <b>[${liarPlayer.name}]</b>ì˜€ìŠµë‹ˆë‹¤.</p>`;
        }

        resultHtml += `
                <div class="bg-indigo-50 p-4 rounded-2xl mb-6 text-center border border-indigo-100">
                    <p class="text-[10px] text-indigo-400 font-bold uppercase tracking-widest">ì‹¤ì œ ì œì‹œì–´</p>
                    <p class="text-2xl font-black text-indigo-700">${gameState.word}</p>
                </div>
                <button onclick="location.reload()" class="w-full py-4 bg-gray-900 text-white rounded-2xl font-bold hover:bg-black transition shadow-lg">ë‹¤ì‹œ ë„ì „í•˜ê¸°</button>
            `;

        document.getElementById("topKeywordDisplay").classList.add("hidden");
        document.getElementById("resultContent").innerHTML = resultHtml;
        document.getElementById("resultModal").classList.remove("hidden");
      }

      document.getElementById("resetBtn").onclick = () => location.reload();
      document.getElementById("userInput").onkeypress = (e) => {
        if (e.key === "Enter") document.getElementById("sendBtn").click();
      };
    </script>
  </body>
</html>
